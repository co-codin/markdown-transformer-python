# –ó–∞–º–µ—Ç–∫–∏ –ø–æ —Å–µ—Å—Å–∏–∏ - –ü—Ä–æ–µ–∫—Ç any_to_md

## –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–Ω–∞ –∫–æ–Ω–µ—Ü —Å–µ—Å—Å–∏–∏)

### ‚úÖ –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è:
1. **–ü—Ä–æ–±–ª–µ–º–∞ —Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤** - –†–ï–®–ï–ù–ê
   - –ü—Ä–∏—á–∏–Ω–∞: –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ —Å–µ—Ä–≤–µ—Ä–∞ —Å `reload=True` —Ç–µ—Ä—è–ª—Å—è –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
   - –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∫ `marker_single` –≤ —Ñ–∞–π–ª–µ `app/converters/marker_converter.py` (—Å—Ç—Ä–æ–∫–∞ 73)
   - –ü—É—Ç—å: `/home/alex/PyProjects/any_to_md/.venv_new/bin/marker_single`

2. **–û—á–∏—Å—Ç–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö** - –í–´–ü–û–õ–ù–ï–ù–ê
   - –£–¥–∞–ª–µ–Ω–æ 42 failed –∑–∞–¥–∞—á–∏ –∏ 2 pending –∑–∞–¥–∞—á–∏
   - –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: `/home/alex/PyProjects/any_to_md/data/tasks.db`

3. **–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç** - –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–û
   - –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
   - –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ

## üîß –ó–∞–¥–∞—á–∏ –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é —Å–µ—Å—Å–∏—é:

### 1. –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –ø—É—Ç–∏ marker_single
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –í–´–°–û–ö–ò–ô**

–ù—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—É—Ç–∏, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å:
- ‚úÖ –í –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ (—Å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ–º `.venv_new`)
- ‚úÖ –í Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ (–≥–¥–µ marker_single —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≥–ª–æ–±–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ pip)

**–ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**
```python
def get_marker_single_path() -> str:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—É—Ç—å –∫ marker_single –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ–∫—Ä—É–∂–µ–Ω–∏—è"""
    
    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ Docker –æ–∫—Ä—É–∂–µ–Ω–∏—è
    if os.path.exists("/.dockerenv") or os.environ.get("DOCKER_CONTAINER"):
        return "marker_single"  # –í Docker —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≥–ª–æ–±–∞–ª—å–Ω–æ
    
    # 2. –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ - –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    venv_paths = [
        "/home/alex/PyProjects/any_to_md/.venv_new/bin/marker_single",
        ".venv_new/bin/marker_single",
        ".venv/bin/marker_single",
    ]
    
    for path in venv_paths:
        if os.path.exists(path):
            return os.path.abspath(path)
    
    # 3. Fallback - –∏—â–µ–º –≤ PATH
    from shutil import which
    if marker_path := which("marker_single"):
        return marker_path
    
    return "marker_single"  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
```

**–ì–¥–µ –≤–Ω–µ—Å—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- –§–∞–π–ª: `app/converters/marker_converter.py`
- –°—Ç—Ä–æ–∫–∞ 73: –∑–∞–º–µ–Ω–∏—Ç—å —Ö–∞—Ä–¥–∫–æ–¥ –Ω–∞ –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏

### 2. –£–ª—É—á—à–µ–Ω–∏–µ cleanup_stale_processing_tasks
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –°–†–ï–î–ù–ò–ô**

–¢–µ–∫—É—â–∞—è –ø—Ä–æ–±–ª–µ–º–∞: –§—É–Ω–∫—Ü–∏—è –ø–æ–º–µ—á–∞–µ—Ç –í–°–ï –∑–∞–¥–∞—á–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "processing" –∫–∞–∫ "failed" –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞.

**–ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ –≤—Ä–µ–º–µ–Ω–∏:**
```python
async def cleanup_stale_processing_tasks(self, timeout_minutes: int = 30) -> int:
    """–ü–æ–º–µ—á–∞–µ—Ç –∫–∞–∫ failed —Ç–æ–ª—å–∫–æ —Ç–µ –∑–∞–¥–∞—á–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤–∏—Å—è—Ç –¥–æ–ª—å—à–µ timeout_minutes"""
    
    cutoff_time = datetime.now() - timedelta(minutes=timeout_minutes)
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ä—ã–µ –∑–∞–¥–∞—á–∏
    await db.execute("""
        UPDATE tasks 
        SET status = 'failed', 
            message = 'Task timeout - server was restarted',
            updated_at = ?
        WHERE status = 'processing' 
        AND created_at < ?
    """, (datetime.now().timestamp(), cutoff_time.timestamp()))
```

**–ì–¥–µ –≤–Ω–µ—Å—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- –§–∞–π–ª: `app/api/database.py`
- –ú–µ—Ç–æ–¥: `cleanup_stale_processing_tasks`

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–∂–∏–º–∞ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –ù–ò–ó–ö–ò–ô**

**–í–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ—à–µ–Ω–∏—è:**
1. –û—Ç–∫–ª—é—á–∏—Ç—å `reload=True` –≤ DEBUG —Ä–µ–∂–∏–º–µ (—Ñ–∞–π–ª `app/main.py`, —Å—Ç—Ä–æ–∫–∞ 31)
2. –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è reload:
   ```python
   RELOAD_ENABLED = os.getenv("RELOAD_ENABLED", "false").lower() == "true"
   ```

### 4. Docker-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –û–¢–õ–û–ñ–ï–ù–û (–ø–æ —Å–ª–æ–≤–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)**

- –í Dockerfile marker-pdf —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω–æ (—Å—Ç—Ä–æ–∫–∞ 38)
- –ú–æ–¥–µ–ª–∏ Marker –∫–æ–ø–∏—Ä—É—é—Ç—Å—è –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ (—Å—Ç—Ä–æ–∫–∞ 48)
- –ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –ø—É—Ç–∏ - –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ Docker

## üìù –í–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞:

### –û–∫—Ä—É–∂–µ–Ω–∏–µ:
- **–í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ**: `.venv_new` (–ù–ï `.venv`!)
- **–ü–æ—Ä—Ç**: 8080 (—É–∫–∞–∑–∞–Ω–æ –≤ CLAUDE.md)
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: SQLite –≤ `data/tasks.db`

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä–æ–≤:
1. **MarkerConverter** - –ø—Ä—è–º–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —á–µ—Ä–µ–∑ marker-pdf
   - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç: PDF, PPTX, XLSX, EPUB
   - –§–∞–π–ª: `app/converters/marker_converter.py`

2. **PdfBridgeConverter** - –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —á–µ—Ä–µ–∑ LibreOffice ‚Üí PDF ‚Üí Marker
   - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç: DOC, DOCX, ODT, RTF, XLS
   - –§–∞–π–ª: `app/converters/pdf_bridge_converter.py`

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
```bash
# –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ (–∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞)
source .venv_new/bin/activate
python app/main.py

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
python client/async_monitor.py

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î
sqlite3 data/tasks.db "SELECT status, COUNT(*) FROM tasks GROUP BY status;"
```

## üéØ –¶–µ–ª—å –Ω–∞ –∑–∞–≤—Ç—Ä–∞:
1. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –ø—É—Ç–∏ marker_single
2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
3. –£–ª—É—á—à–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é cleanup_stale_processing_tasks —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≤—Ä–µ–º–µ–Ω–∏
4. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ

---
*–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –∫–æ–Ω–µ—Ü —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏*
*–°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞: –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω—É–∂–Ω—ã —É–ª—É—á—à–µ–Ω–∏—è –¥–ª—è production*